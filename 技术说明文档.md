# 实验室预约系统技术说明文档

## 项目文件结构

```
实验室预约系统/
├── manage.py                           # Django管理脚本
├── db.sqlite3                          # SQLite数据库文件
├── lab_reservation_system/             # 项目配置目录
│   ├── __init__.py                     # Python包初始化文件
│   ├── settings.py                     # Django项目配置文件
│   ├── urls.py                         # 项目主URL配置
│   ├── wsgi.py                         # WSGI部署配置
│   └── asgi.py                         # ASGI部署配置
├── reservations/                       # 主应用目录
│   ├── __init__.py                     # Python包初始化文件
│   ├── models.py                       # 数据模型定义
│   ├── views.py                        # 视图函数
│   ├── urls.py                         # 应用URL配置
│   ├── forms.py                        # 表单定义
│   ├── admin.py                        # Django管理界面配置
│   ├── apps.py                         # 应用配置
│   ├── tests.py                        # 测试文件
│   ├── migrations/                     # 数据库迁移文件
│   │   ├── 0001_initial.py             # 初始数据库结构
│   │   └── 0002_alter_laboratory_options_laboratory_category.py  # 分类功能迁移
│   └── templates/reservations/         # HTML模板文件
│       ├── base.html                   # 基础模板
│       ├── laboratory_list.html        # 实验室列表页面
│       ├── laboratory_detail.html      # 实验室详情页面
│       ├── make_reservation.html       # 预约申请页面
│       ├── my_reservations.html        # 用户预约记录页面
│       ├── login.html                  # 登录页面
│       ├── register.html               # 注册页面
│       ├── user_profile.html           # 用户资料页面
│       ├── admin_panel.html            # 管理员面板
│       └── admin_reservations.html     # 管理员预约审核页面
├── create_sample_data.py               # 示例数据生成脚本
├── add_more_labs.py                    # 添加更多实验室脚本
└── update_lab_categories.py            # 更新实验室分类脚本
```

## 核心配置文件

### `lab_reservation_system/settings.py`
Django项目的主要配置文件，包含：
- 数据库配置（SQLite）
- 应用注册（reservations）
- 中间件配置
- 模板配置
- 静态文件配置
- 国际化设置（中文）

### `lab_reservation_system/urls.py`
项目主URL配置，将所有URL路由到reservations应用。

## 数据模型 (`reservations/models.py`)

### Laboratory模型
实验室信息模型，包含以下字段：
- `name`: 实验室名称
- `category`: 科目分类（11个选项）
- `location`: 位置
- `capacity`: 容量
- `equipment`: 设备描述
- `description`: 实验室描述
- `is_active`: 是否可用
- `created_at`: 创建时间

#### 分类选项
```python
CATEGORY_CHOICES = [
    ('physics', '物理'),
    ('chemistry', '化学'),
    ('biology', '生物'),
    ('computer', '计算机'),
    ('engineering', '工程'),
    ('mathematics', '数学'),
    ('electronics', '电子'),
    ('materials', '材料'),
    ('environmental', '环境'),
    ('medical', '医学'),
    ('other', '其他'),
]
```

#### 关键方法
- `get_category_icon()`: 返回分类对应的FontAwesome图标类名
- `get_category_color()`: 返回分类对应的颜色代码

### TimeSlot模型
时间段模型，定义可预约的时间段：
- `name`: 时间段名称
- `start_time`: 开始时间
- `end_time`: 结束时间
- `is_active`: 是否可用

### Reservation模型
预约记录模型：
- `user`: 预约用户（外键）
- `laboratory`: 预约实验室（外键）
- `date`: 预约日期
- `start_time`: 开始时间
- `end_time`: 结束时间
- `purpose`: 预约目的
- `status`: 预约状态（待审核/已批准/已拒绝/已取消）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### UserProfile模型
用户扩展信息模型：
- `user`: 用户（一对一关系）
- `student_id`: 学号
- `phone`: 电话号码
- `department`: 院系

## 视图函数 (`reservations/views.py`)

### 主要视图函数

#### `laboratory_list(request)`
实验室列表页面视图，支持：
- 搜索功能（名称、位置、描述、设备）
- 分类筛选
- 分类统计计算

#### `laboratory_detail(request, lab_id)`
实验室详情页面视图，显示：
- 实验室详细信息
- 可用时间段
- 预约表单

#### `make_reservation(request, lab_id)`
预约申请视图，处理：
- 预约表单提交
- 时间冲突检测
- 预约记录创建

#### `my_reservations(request)`
用户预约记录视图，显示：
- 用户所有预约记录
- 预约状态
- 取消预约功能

#### `admin_panel(request)`
管理员面板视图，提供：
- 系统统计信息
- 预约审核入口

#### `admin_reservations(request)`
管理员预约审核视图，支持：
- 预约列表查看
- 批准/拒绝操作

#### AJAX接口
- `check_availability(request)`: 检查预约时间可用性
- `laboratory_list_ajax(request)`: 返回实验室列表JSON数据

## URL配置 (`reservations/urls.py`)

定义了所有页面和API接口的URL路由：
- 主页面路由
- 用户认证路由
- 管理员功能路由
- AJAX API路由

## 表单定义 (`reservations/forms.py`)

### ReservationForm
预约申请表单，包含：
- 预约日期选择
- 时间段选择
- 预约目的输入
- 表单验证逻辑

### UserProfileForm
用户资料表单，用于用户信息编辑。

## 管理界面配置 (`reservations/admin.py`)

### LaboratoryAdmin
实验室管理界面配置：
- 列表显示字段：名称、分类、位置、容量、状态
- 筛选器：分类、状态、创建时间
- 搜索字段：名称、位置、描述
- 可编辑字段：状态、分类
- 字段分组显示

### 其他Admin配置
- TimeSlotAdmin: 时间段管理
- ReservationAdmin: 预约记录管理
- UserProfileAdmin: 用户资料管理

## 模板文件

### `base.html`
基础模板文件，包含：
- HTML文档结构
- Bootstrap CSS框架
- FontAwesome图标库
- 导航栏
- 页脚
- 自定义CSS样式
- JavaScript功能

#### 重要CSS类
- `.hero-banner`: 首页横幅样式
- `.lab-card`: 实验室卡片样式
- `.category-btn`: 分类按钮样式
- `.category-badge`: 分类标签样式

### `laboratory_list.html`
实验室列表页面模板：
- Hero Banner区域
- 搜索和分类筛选区域
- 实验室卡片网格布局
- 空状态显示
- 功能介绍区域

### 其他模板文件
各个功能页面的HTML模板，继承自base.html。

## 数据库迁移文件

### `0001_initial.py`
初始数据库结构迁移，创建所有基础模型表。

### `0002_alter_laboratory_options_laboratory_category.py`
添加实验室分类功能的迁移文件：
- 添加category字段
- 修改模型Meta选项

## 辅助脚本

### `create_sample_data.py`
生成示例数据脚本：
- 创建超级用户
- 创建示例实验室
- 创建时间段
- 创建测试用户

### `add_more_labs.py`
添加更多实验室的脚本，创建不同分类的实验室示例。

### `update_lab_categories.py`
更新现有实验室分类的脚本，根据名称自动分配分类。

## 实验室图标修改详细说明

### 图标配置位置
实验室卡片的图标配置位于 `reservations/models.py` 文件中的 `Laboratory` 模型。

### 修改步骤

#### 1. 定位图标映射代码
在 `reservations/models.py` 文件的第41-56行，找到 `get_category_icon()` 方法：

```python
def get_category_icon(self):
    """根据分类返回对应的图标"""
    icon_map = {
        'physics': 'fas fa-atom',
        'chemistry': 'fas fa-flask',
        'biology': 'fas fa-dna',
        'computer': 'fas fa-desktop',
        'engineering': 'fas fa-cogs',
        'mathematics': 'fas fa-calculator',
        'electronics': 'fas fa-microchip',
        'materials': 'fas fa-cube',
        'environmental': 'fas fa-leaf',
        'medical': 'fas fa-heartbeat',
        'other': 'fas fa-microscope',
    }
    return icon_map.get(self.category, 'fas fa-microscope')
```

#### 2. 修改图标
要修改某个分类的图标，只需更改对应的FontAwesome类名。例如：
- 将物理实验室图标改为分子图标：`'physics': 'fas fa-atom'` → `'physics': 'fas fa-molecule'`
- 将化学实验室图标改为试管图标：`'chemistry': 'fas fa-flask'` → `'chemistry': 'fas fa-test-tube'`

#### 3. 添加新分类图标
如果添加新的实验室分类，需要：
1. 在 `CATEGORY_CHOICES` 中添加新分类
2. 在 `icon_map` 中添加对应图标
3. 在 `get_category_color()` 方法中添加对应颜色

#### 4. 可用图标资源
系统使用FontAwesome 5图标库，可用图标包括：
- `fas fa-microscope`: 显微镜
- `fas fa-flask`: 烧瓶
- `fas fa-atom`: 原子
- `fas fa-dna`: DNA
- `fas fa-desktop`: 电脑
- `fas fa-cogs`: 齿轮
- `fas fa-calculator`: 计算器
- `fas fa-microchip`: 芯片
- `fas fa-cube`: 立方体
- `fas fa-leaf`: 叶子
- `fas fa-heartbeat`: 心跳

#### 5. 颜色配置
图标颜色在同一文件的 `get_category_color()` 方法中配置（第58-73行）：

```python
def get_category_color(self):
    """根据分类返回对应的颜色"""
    color_map = {
        'physics': '#6f42c1',      # 紫色
        'chemistry': '#fd7e14',    # 橙色
        'biology': '#198754',      # 绿色
        # ... 其他颜色配置
    }
    return color_map.get(self.category, '#495057')
```

#### 6. 应用修改
修改完成后，重启Django开发服务器即可看到效果：
```bash
python manage.py runserver 127.0.0.1:8083
```

### 模板中的图标使用
图标在模板中通过以下方式调用：
- `laboratory_list.html` 第103行：`<i class="{{ lab.get_category_icon }}"></i>`
- 图标颜色通过内联样式应用：`style="background: linear-gradient(135deg, {{ lab.get_category_color }}, {{ lab.get_category_color }}dd);"`

## 数据流关系

### 用户预约流程
1. 用户访问实验室列表页面 (`laboratory_list`)
2. 选择实验室查看详情 (`laboratory_detail`)
3. 提交预约申请 (`make_reservation`)
4. 系统检查时间冲突 (`check_availability`)
5. 创建预约记录 (Reservation模型)
6. 管理员审核预约 (`admin_reservations`)
7. 用户查看预约状态 (`my_reservations`)

### 分类筛选流程
1. 页面加载时获取所有分类统计 (`laboratory_list` 视图)
2. 用户点击分类按钮触发JavaScript事件
3. 提交表单到同一视图进行筛选
4. 返回筛选后的实验室列表
5. 可选：使用AJAX接口 (`laboratory_list_ajax`) 实现无刷新筛选

### 数据模型关系
- User ↔ UserProfile (一对一)
- User → Reservation (一对多)
- Laboratory → Reservation (一对多)
- Laboratory.category → 图标和颜色映射 (通过模型方法)
